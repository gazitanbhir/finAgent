{# templates/chat_message_fragment.html #}
{% set base_class = "message p-3 rounded-xl max-w-[85%] shadow-md hover:shadow-lg transition-all duration-300 ease-in-out" %}
{% set sender_bubble_class = "" %}
{% set header_class = "text-xs font-semibold mb-1.5 tracking-wide uppercase flex items-center gap-1.5" %}
{% set text_class = "text-sm leading-relaxed break-words" %}
{% set icon_svg = "" %}
{% set sender_name = "AI Assistant" %}
{# Common prose styles for agent/info/error messages #}
{% set prose_styles = "prose prose-sm max-w-none prose-slate prose-p:my-1 prose-headings:my-2 prose-headings:font-semibold prose-headings:text-slate-700 prose-a:text-indigo-600 hover:prose-a:text-indigo-800 prose-code:text-purple-700 prose-code:bg-purple-50 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:font-mono prose-code:text-xs prose-pre:bg-slate-800 prose-pre:text-slate-100 prose-pre:p-3 prose-pre:rounded-md prose-pre:text-xs prose-pre:overflow-x-auto prose-blockquote:border-l-4 prose-blockquote:border-slate-300 prose-blockquote:pl-3 prose-blockquote:italic prose-blockquote:text-slate-600 prose-ul:my-2 prose-ul:list-disc prose-ul:pl-5 prose-ol:my-2 prose-ol:list-decimal prose-ol:pl-5 prose-strong:font-semibold prose-strong:text-slate-700" %}


{% if sender == 'user' %}
    {# User Message: Gradient background, aligned right #}
    {% set sender_bubble_class = "ml-auto bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-br-none" %}
    {% set text_class = text_class ~ " text-white" %} {# Ensure text is white #}
{% elif sender == 'agent welcome' %}
    {# Welcome Message: Special gradient, aligned left, distinct border #}
    {% set base_class = "message p-3 rounded-xl max-w-[85%] mr-auto bg-gradient-to-br from-indigo-50 to-purple-50 text-slate-800 rounded-bl-none border-l-4 border-indigo-400 shadow-md hover:shadow-lg transition-all" %}
    {% set header_class = header_class ~ " text-indigo-600" %}
    {% set icon_svg %}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M9.98 1.03a.75.75 0 01.04 0A8.002 8.002 0 0118 9v5.25a.75.75 0 01-1.5 0V9A6.502 6.502 0 003.02 7.623 1.75 1.75 0 01.695 9.815 9.502 9.502 0 009.98 1.03z" /><path d="M11.2 9.49a2.5 2.5 0 10-3.9 0 3.5 3.5 0 00-1.145 2.554 5.25 5.25 0 006.19 0 3.5 3.5 0 00-1.145-2.554zM12 14.25a.75.75 0 010 1.5h-4a.75.75 0 010-1.5h4z" /></svg>{% endset %}
{% elif sender == 'error' %}
    {# Error Message: Red theme, aligned left #}
    {% set sender_bubble_class = "mr-auto bg-red-50/90 text-red-900 rounded-bl-none border-l-4 border-red-400 backdrop-blur-sm" %}
    {% set header_class = header_class ~ " text-red-600" %}
    {% set icon_svg %}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>{% endset %}
    {% set sender_name = "Error" %}
{% elif sender == 'info' %}
    {# Info Message: Blue theme, aligned left #}
    {% set sender_bubble_class = "mr-auto bg-sky-50/90 text-sky-900 rounded-bl-none border-l-4 border-sky-400 backdrop-blur-sm" %}
    {% set header_class = header_class ~ " text-sky-600" %}
    {% set icon_svg %}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" /></svg>{% endset %}
    {% set sender_name = "Info" %}
{% else %} {# Default Agent styling #}
    {# Agent Message: Subtle slate theme, aligned left #}
    {% set sender_bubble_class = "mr-auto bg-slate-50/90 text-slate-800 rounded-bl-none border-l-4 border-slate-300 backdrop-blur-sm" %}
    {% set header_class = header_class ~ " text-slate-500" %}
    {% set icon_svg %}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M9.98 1.03a.75.75 0 01.04 0A8.002 8.002 0 0118 9v5.25a.75.75 0 01-1.5 0V9A6.502 6.502 0 003.02 7.623 1.75 1.75 0 01.695 9.815 9.502 9.502 0 009.98 1.03z" /><path d="M11.2 9.49a2.5 2.5 0 10-3.9 0 3.5 3.5 0 00-1.145 2.554 5.25 5.25 0 006.19 0 3.5 3.5 0 00-1.145-2.554zM12 14.25a.75.75 0 010 1.5h-4a.75.75 0 010-1.5h4z" /></svg>{% endset %}
{% endif %}

{# Outer div contains the message bubble #}
<div class="{{ base_class }} {{ sender_bubble_class }}">
    {# Conditionally show header for non-user messages #}
    {% if sender != 'user' %}
    <div class="{{ header_class }}">
        {{ icon_svg | safe }}
        <span>{{ sender_name }}</span>
    </div>
    {% endif %}

    {# Message content area #}
    <div class="{{ text_class }} {% if sender != 'user' %}{{ prose_styles }}{% endif %}">
        {{ message | safe }} {# Assume message is pre-sanitized HTML/Markdown #}
    </div>
</div>